<%= @js_lib %>

$(function() {

  //////////////////
  // Callbacks
  //////////////////
  
  // Loading bookmarks callback
  window.bkbkLoad = function(data) {
    loading.hide();
    $.each(data, function(key, value) {
      list.append($('<li>').append($('<a>').attr('href',value).text(key)));
    });
  };
  
  window.bkbkAdd = function(data) {
    
  };
  
  window.bkbkEdit = function(data) {
    
  };
  
  window.bkbkDelete = function(data) {
    
  };
  
  var addRemote = function(path, callback) {
    var remoteScript = document.createElement('script');
    remoteScript.setAttribute('src','//<%= host_with_port %>/' + path + '?callback=' + callback);
    remoteScript.setAttribute('type','text/javascript');
    document.body.appendChild(remoteScript);
  };
  
  var user = '<%= @user.uuid %>';
  var styles = "<%= @styles %>";
  var body = $('body');

  // Create style wrapper
  var style = $('<style>').attr('type','text/css').text(styles);
  
  // Create bookmark container and list
  var container = $('<div>').addClass('bkbk');
  var search = $('<div>').addClass('bkbk-search');
  search.append($('<input>').attr('type','search').attr('placeholder','Search'));
  var list = $('<ul>');
  var loading = $('<img>').attr('src','//<%= host_with_port %>/images/indicator_medium.gif').addClass('bkbk-loading');
  
  // Add UI elements to the container
  container.prepend(list).prepend(loading).prepend(search);
  
  // Stop propagation of click events in the container so as to not close the panel
  container.on('click', function(e) {
    e.stopPropagation();
  });
  
  // Watch for clicks on the background and close the panel
  $(document).one('click', function(e) {
    container.animate({'left':'-305px'}, 500, 'ease');
  });
  
  // Add styles and container to page
  body.prepend(style).prepend(container);
  
  // Show the list and put the cursor in the search box
  container.animate({'left':'0'}, 500, 'ease');
  search.find('input').focus();
  
  // Finally, load the list of bookmarks
  addRemote(user+'/bookmarks', 'bkbkLoad');
});
